<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/style/prep.css">
    <title>Battleship Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="board">
            <% for (let i = 0; i < 10; i++) { %>
                <% for (let j = 0; j < 10; j++) { %>
                    <div data-row="<%= i %>" data-col="<%= j %>"></div>
                <% } %>
            <% } %>
        </div>

        <div class="info">
            <h3>Available Ships</h3>
            <ul id="ship-list">
                <% for (let size of [2, 2, 2, 2, 3, 3, 4, 4, 5]) { %>
                    <li><%= size %> x</li>
                <% } %>
            </ul>
            <button id="add">Add Ship</button>
            <button id="clear">Clear</button>
            <button id="confirm">Confirm</button>
        </div>
    </div>
    <script src="/js/API.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/actions.js"></script>
    <script>
        let shipSizes = Object.values(document.querySelectorAll('ul#ship-list li')).map(el => Number(el.innerHTML[0]));
        let parts = [];
        const urlParams = new URLSearchParams(window.location.search);
        const Player = urlParams.get('player');
        const Id = urlParams.get('id');

        function validateShip(shipParts) {
            let dist = 0;
            const rows = shipParts.map(([row, col]) => Number(row));
            const cols = shipParts.map(([row, col]) => Number(col));

            if (rows.every(row => row === rows[0])) {
                dist = Math.abs(Math.min(...cols), Math.max(...cols))
            } else if (cols.every(col => col === cols[0])) {          
                dist = Math.abs(Math.min(...rows), Math.max(...rows))
            }
            return dist;
        }

        function crossOutShip() {
            const index = shipSizes.indexOf(parts.length)
            shipSizes.splice(index, 1)
        }

        function toggleCellSelection(row, col) {
            const cell = document.querySelector(`[data-row='${row}'][data-col='${col}']`);
            cell.classList.toggle('selected');
        }

        function addCurrentChoice(row, col) {
            currentChoice.push([row, col]);
            toggleCellSelection(row, col);
        }

        document.querySelectorAll('.board div').forEach(field => field.addEventListener('click', () => {
            if (!field.classList.contains('selected')) {
                parts.push([field.attributes['data-row'].value, field.attributes['data-col'].value])
                field.classList.add('selected')
            } else {
                field.classList.remove("selected");
                parts.splice(parts.indexOf([field.attributes['data-row'].value, field.attributes['data-col'].value]), 1)
            }
        }))

        document.getElementById('add').addEventListener('click', () => {
            if(shipSizes.includes(validateShip(parts))) {
                actions.makePrepChoice(Player, Id, parts)
                crossOutShip();
                parts = [];
            }
        })

        document.getElementById('clear').addEventListener('click', () => {
            parts = [];
            document.querySelectorAll('.board div').forEach(cell => cell.classList.remove('selected'));
        });

        document.getElementById('confirm').addEventListener('click', () => {

        });
    </script>
</body>
</html>
